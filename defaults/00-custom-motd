#!/usr/bin/env bash
#
# Custom MOTD — installed by clean-ubuntu.sh
#

# Colors
R='\033[0;31m'
G='\033[0;32m'
Y='\033[1;33m'
B='\033[0;34m'
C='\033[0;36m'
M='\033[0;35m'
W='\033[1;37m'
D='\033[0;90m'
NC='\033[0m'
BOLD='\033[1m'

# ─── System info ──────────────────────────────────────────────────────────
HOSTNAME=$(hostname)
OS=$(. /etc/os-release && echo "$PRETTY_NAME")
KERNEL=$(uname -r)
UPTIME=$(uptime -p 2>/dev/null | sed 's/^up //' || echo "unknown")
LOAD=$(awk '{printf "%.2f %.2f %.2f", $1, $2, $3}' /proc/loadavg)
CPU_CORES=$(nproc 2>/dev/null || echo "?")

# Memory
read -r MEM_TOTAL MEM_AVAIL <<< "$(awk '/MemTotal/{t=$2} /MemAvailable/{a=$2} END{printf "%d %d", t/1024, a/1024}' /proc/meminfo)"
MEM_USED=$((MEM_TOTAL - MEM_AVAIL))
MEM_PCT=$((MEM_USED * 100 / MEM_TOTAL))

# Disk (root partition)
read -r DISK_TOTAL DISK_USED DISK_AVAIL DISK_PCT <<< "$(df -BG / | awk 'NR==2{gsub("G",""); print $2, $3, $4, int($5)}')"

# IP addresses
IPS=$(hostname -I 2>/dev/null | tr ' ' '\n' | head -3 | tr '\n' ' ')

# Users
USERS=$(who 2>/dev/null | wc -l)

# Updates
UPDATES=$(apt list --upgradable 2>/dev/null | grep -c 'upgradable' || true)
UPDATES=${UPDATES:-0}

# ─── Color-coded usage bar ────────────────────────────────────────────────
usage_bar() {
    local pct=$1 width=30
    local filled=$((pct * width / 100))
    local empty=$((width - filled))
    local color="$G"
    [[ $pct -ge 60 ]] && color="$Y"
    [[ $pct -ge 85 ]] && color="$R"
    printf "${color}"
    printf '█%.0s' $(seq 1 $filled 2>/dev/null) || true
    printf "${D}"
    [[ $empty -gt 0 ]] && printf '░%.0s' $(seq 1 $empty 2>/dev/null) || true
    printf "${NC} ${color}${pct}%%${NC}"
}

# ─── Render ───────────────────────────────────────────────────────────────
echo ""
echo -e "  ${C}${BOLD}┌──────────────────────────────────────────────────────┐${NC}"
printf "  ${C}${BOLD}│${NC}  ${W}${BOLD}%-50s${NC}  ${C}${BOLD}│${NC}\n" "$HOSTNAME"
echo -e "  ${C}${BOLD}├──────────────────────────────────────────────────────┤${NC}"
printf "  ${C}${BOLD}│${NC}  ${D}%-50s${NC}  ${C}${BOLD}│${NC}\n" "$OS"
printf "  ${C}${BOLD}│${NC}  ${D}Kernel: %-42s${NC}  ${C}${BOLD}│${NC}\n" "$KERNEL"
printf "  ${C}${BOLD}│${NC}  ${D}%-50s${NC}  ${C}${BOLD}│${NC}\n" "clean-ubuntu v1.5"
echo -e "  ${C}${BOLD}└──────────────────────────────────────────────────────┘${NC}"
echo ""
echo -e "  ${W}${BOLD}System${NC}"
echo -e "  ${D}├─${NC} ${B}Uptime:${NC}    $UPTIME"
echo -e "  ${D}├─${NC} ${B}Load:${NC}      $LOAD ${D}(${CPU_CORES} cores)${NC}"
echo -e "  ${D}├─${NC} ${B}Users:${NC}     $USERS logged in"
echo -e "  ${D}└─${NC} ${B}Updates:${NC}   $UPDATES pending"
echo ""
echo -e "  ${W}${BOLD}Resources${NC}"
echo -ne "  ${D}├─${NC} ${B}Memory:${NC}    "
usage_bar "$MEM_PCT"
echo -e "  ${D}(${MEM_USED}M / ${MEM_TOTAL}M)${NC}"
echo -ne "  ${D}└─${NC} ${B}Disk /:${NC}    "
usage_bar "$DISK_PCT"
echo -e "  ${D}(${DISK_USED}G / ${DISK_TOTAL}G)${NC}"
echo ""
echo -e "  ${W}${BOLD}Network${NC}"
echo -e "  ${D}└─${NC} ${B}IP:${NC}        $IPS"
echo ""
